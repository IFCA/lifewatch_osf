{#
# This file is part of Lifewatch DAAP.
# Copyright (C) 2015 Ana Yaiza Rodriguez Marrero.
#
# Lifewatch DAAP is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# Lifewatch DAAP is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with Lifewatch DAAP. If not, see <http://www.gnu.org/licenses/>.
#}


{% extends 'projects/show.html' %}
{% set active='publish' %}


{% from 'projects/macros.tpl' import record_table with context %}


{% block javascript %}
{{ super() }}
<script type="text/javascript">
var publishUrl
require(['jquery'], function($) {
    $('#publishmodal').on('show.bs.modal', function (event) {
      var a = $(event.relatedTarget)
      publishUrl = a.data('publishUrl') // Extract info from data-* attributes
      var modal = $(this)
      modal.find('#publishform').attr('action', publishUrl);
      });
    });
</script>
{% endblock %}


{% block project_body %}
<div id="publishmodal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="publishmodal_label" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="publishmodal_label">Publish record?</h4>
      </div>
      <div class="modal-body">
        <ul>
            <li>Would you like to public this record?</li> 
            <li>If you publish it, the record will be public according to the access right you had set.</li>
        </ul>
      </div>
      <div class="alert help-block alert-danger" id="publishmodal-state-title" style="display: none;">
      </div>
      <div class="modal-footer">
        <form id="publishform" action="#" method="POST">
          {%- for field in publishform %}{{ field }}{% endfor %}
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" 
                  onclick='$.post(publishUrl)
                                .done(function(data) {
                                        if (data.redirect) {
                                           window.location.replace(data.redirect);
                                        } else {
                                          $("#publishmodal").modal("hide")
                                        }
                                      })
                                .fail(function(jqXHR) {
                                        var m = jQuery.parseJSON(jqXHR.responseText).msg;
                                        var st = $("#publishmodal-state-title");
                                        st.html("<p>" + m + "</p>");
                                        st.show(); 
                                      });'>Publish</button>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="col-md-12">
  <h3>Publish</h3>
  <p>
  Lorem ipsum dolor sit amet, consectetur adipiscing elit. Mauris lacinia metus volutpat scelerisque facilisis. Cras arcu orci, facilisis eget bibendum eu, ullamcorper nec nulla. Donec et elementum mauris, non aliquet nisl. Aliquam vitae eros vel mi euismod laoreet. Vestibulum varius euismod suscipit. Mauris pulvinar, nisi vitae tincidunt rutrum, dolor elit vehic
  </p>
  {{ record_table('publish', records, "Project records")|safe}}
</div>
{% endblock %}
